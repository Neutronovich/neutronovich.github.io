<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App: Работа с FPIBANK (Jetton)</title>
  
  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
  <h1>Работа с FPIBANK через TonConnect (TonWeb)</h1>

  <div id="ton-connect"></div>
  <button id="sendTransaction">Отправить все FPIBANK (Transfer)</button>
  <button id="mintTransaction">Mint 17 000 FPIBANK</button>

  <script>
    if (typeof Telegram === "undefined") {
      window.Telegram = { WebApp: { ready: () => {}, showAlert: alert } };
    } else {
      Telegram.WebApp.ready();
    }

    // Инициализация TonConnect UI
    const tonConnectUI = new TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect",
    });

    const jettonTransferMasterAddress = "0:f42a9711321fac28edb3e7ebce8e0bc58d34f9f2d3bed8d9afc6a839a1c15016";
    const jettonMinterAddress       = "0:e30add4d70c9d489150ae473898d453cb81fb6c805032d81b233d6c222435e7d";
    const recipientTonAddress       = "0:1768dacd6490d4672eecae44c218a32a4db767e97797683b31dee87ba9cac516";

    function isValidTonAddress(address) {
      return /^0:[a-fA-F0-9]{64}$/.test(address);
    }

    // ——— секция Transfer (оставляем как есть) ———
    async function getOrCreateRecipientJettonWallet(addr) {
      try {
        const resp = await fetch(`https://tonapi.io/v2/accounts/${addr}/jettons`);
        const data = await resp.json();
        const jd = data.balances.find(j => j.jetton.address === jettonTransferMasterAddress);
        return jd ? jd.wallet_address.address : addr;
      } catch {
        return addr;
      }
    }

    async function getUserFPIBankData(addr) {
      try {
        const resp = await fetch(`https://tonapi.io/v2/accounts/${addr}/jettons`);
        const data = await resp.json();
        const jd = data.balances.find(j => j.jetton.address === jettonTransferMasterAddress);
        if (!jd) return { rawBalance: "0", decimals: 9, userJettonWallet: null };
        return {
          rawBalance: jd.balance,
          decimals: jd.jetton.decimals,
          userJettonWallet: jd.wallet_address.address,
        };
      } catch {
        return { rawBalance: "0", decimals: 9, userJettonWallet: null };
      }
    }

    async function createJettonTransferPayload(amount, toWallet, userAddr) {
      const { Cell } = TonWeb.boc;
      const { BN }   = TonWeb.utils;
      if (!isValidTonAddress(toWallet) || !isValidTonAddress(userAddr)) return null;
      const cell = new Cell();
      cell.bits.writeUint(0x0f8a7ea5, 32);
      cell.bits.writeUint(0, 64);
      cell.bits.writeCoins(new BN(amount.toString()));
      cell.bits.writeAddress(new TonWeb.Address(toWallet));
      cell.bits.writeAddress(new TonWeb.Address(userAddr));
      cell.bits.writeBit(0);
      cell.bits.writeCoins(new BN(0));
      cell.bits.writeBit(0);
      const boc = await cell.toBoc(false);
      return TonWeb.utils.bytesToBase64(boc);
    }

    async function sendAllFPIBANK(userAddr, recipientAddr) {
      const { rawBalance, decimals, userJettonWallet } = await getUserFPIBankData(userAddr);
      if (!userJettonWallet || rawBalance === "0") {
        return Telegram.WebApp.showAlert("Недостаточный баланс или кошелёк не найден!");
      }
      const recipWallet = await getOrCreateRecipientJettonWallet(recipientAddr);
      const payload = await createJettonTransferPayload(rawBalance, recipWallet, userAddr);
      if (!payload) return Telegram.WebApp.showAlert("Ошибка при создании транзакции!");
      const tx = {
        validUntil: Math.floor(Date.now()/1000) + 3600,
        messages: [{
          address: userJettonWallet,
          amount: "100000000",
          payload,
        }],
      };
      try {
        const res = await tonConnectUI.sendTransaction(tx);
        Telegram.WebApp.showAlert(`Отправлено! TX: ${JSON.stringify(res)}`);
      } catch(e) {
        Telegram.WebApp.showAlert("Ошибка транзакции: " + e.message);
      }
    }
    // ——— конец Transfer ———

    // ——— секция Mint фиксировано 17 000 токенов ———
    const MINT_OP = 21;                       // opcode op::mint()
    const FIXED_RAW = BigInt(17_000) * 10n**9n; // 17 000 × 10^9

    async function createMintPayload(amountRaw, toAddress) {
      const { Cell } = TonWeb.boc;
      const { BN }   = TonWeb.utils;
      if (!isValidTonAddress(toAddress)) return null;

      // тело
      const body = new Cell();
      body.bits.writeUint(MINT_OP, 32);
      body.bits.writeUint(0n, 64);
      body.bits.writeAddress(new TonWeb.Address(toAddress));
      body.bits.writeCoins(new BN(amountRaw.toString()));

      // master_ref
      const master = new Cell();
      master.bits.writeUint(0, 32);
      master.bits.writeUint(0n, 64);
      master.bits.writeCoins(new BN(amountRaw.toString()));
      body.refs.push(master);

      try {
        const boc = await body.toBoc(false);
        return TonWeb.utils.bytesToBase64(boc);
      } catch {
        return null;
      }
    }

    async function sendMintTransaction(userAddr) {
      const payload = await createMintPayload(FIXED_RAW, userAddr);
      if (!payload) return Telegram.WebApp.showAlert("Не удалось собрать mint-payload");
      const tx = {
        validUntil: Math.floor(Date.now()/1000) + 3600,
        messages: [{
          address: jettonMinterAddress,
          amount:  "50000000",
          payload,
        }],
      };
      try {
        const res = await tonConnectUI.sendTransaction(tx);
        Telegram.WebApp.showAlert(`Mint 17 000 выполнен! TX: ${JSON.stringify(res)}`);
      } catch(e) {
        Telegram.WebApp.showAlert("Ошибка mint: " + e.message);
      }
    }
    // ——— конец Mint ———

    document.getElementById("sendTransaction")
      .addEventListener("click", () => {
        if (!tonConnectUI.connected) return Telegram.WebApp.showAlert("Подключите кошелёк.");
        const addr = tonConnectUI.wallet?.account?.address;
        if (!addr) return Telegram.WebApp.showAlert("Не удалось получить адрес.");
        sendAllFPIBANK(addr, recipientTonAddress);
      });

    document.getElementById("mintTransaction")
      .addEventListener("click", () => {
        if (!tonConnectUI.connected) return Telegram.WebApp.showAlert("Подключите кошелёк.");
        const addr = tonConnectUI.wallet?.account?.address;
        if (!addr) return Telegram.WebApp.showAlert("Не удалось получить адрес.");
        sendMintTransaction(addr);
      });

  </script>
</body>
</html>
