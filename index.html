<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' 'unsafe-eval' 'unsafe-inline' https://telegram.org https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com;
    connect-src 'self' https://bridge.tonapi.io https://tonconnect.manifestapi.io;
    font-src 'self' https://unpkg.com;
    img-src 'self' data: https://unpkg.com https://*.ton.org https://tonkeeper.com https://raw.githubusercontent.com https://ton.app;
  ">

  <title>Telegram Mini App: TON Connect UI Demo</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-webapp.js"></script>

  <!-- TON Connect SDK -->
  <script src="./js/tonconnect-sdk.min.js"></script>

  <!-- TON Connect UI CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css">
  
  <!-- TON Connect UI JS -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <h1>Telegram Mini App: TON Connect UI Demo</h1>

  <!-- Контейнер для TON Connect UI -->
  <div id="ton-connect"></div>

  <button id="sendTransaction">Отправить 1 TON</button>

  <script>
    if (typeof Telegram === "undefined") {
      window.Telegram = {
        WebApp: {
          ready: () => console.log("Telegram WebApp ready stub"),
          showAlert: (msg) => alert(msg)
        }
      };
    } else {
      Telegram.WebApp.ready();
    }

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    async function sendTransaction() {
      if (!tonConnectUI.connected) {
        Telegram.WebApp.showAlert("Сначала подключите кошелек.");
        return;
      }

      const amount = "1000000000"; // 1 TON
      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 360, // валидно 6 минут
        messages: [
          {
            address: "UQDlN_V6Eaj3ac60yvc3tWa75pnAXNVdmHF3OL71er9PEBRd",
            amount: amount,
          }
        ]
      };

      try {
        const result = await tonConnectUI.sendTransaction(transaction);
        console.log("Результат транзакции:", result);
        Telegram.WebApp.showAlert("Транзакция отправлена: " + JSON.stringify(result));
      } catch (error) {
        console.error("Ошибка транзакции:", error);
        Telegram.WebApp.showAlert("Ошибка транзакции: " + error.message);
      }
    }

    document.getElementById("sendTransaction").addEventListener("click", sendTransaction);
  </script>
</body>
</html>
