<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App: Отправка всех FPIBANK (Jetton)</title>

  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
  <h1>Отправка всех FPIBANK через TonConnect (TonWeb)</h1>
  <div id="ton-connect"></div>
  <button id="sendTransaction">Отправить все FPIBANK</button>

  <script>
    // Telegram init
    if (typeof Telegram === "undefined") {
      window.Telegram = { WebApp: { ready: () => {}, showAlert: alert } };
    } else {
      Telegram.WebApp.ready();
    }

    // TonConnect UI
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect",
    });

    // === Твои адреса (friendly, mainnet) ===
    const JETTON_MINTER_FRIENDLY = "EQD0KpcRMh-sKO2z5-vOjgvFjTT58tO-2Nmvxqg5ocFQFtWz";
    const RECIPIENT_OWNER_FRIENDLY = "EQAXaNrNZJDUZy7srkTCGKMqTbdn6XeXaDsx3uh7qcrFFqk2";

    // helpers
    const toAddr = (a) => new TonWeb.Address(a);
    async function safeJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    // Наш jetton-кошелёк и баланс
    async function getMyJettonWalletAndBalance(ownerFriendly) {
      const data = await safeJson(`https://tonapi.io/v2/accounts/${ownerFriendly}/jettons`);
      const hit = (data.balances || []).find(j => j.jetton.address === JETTON_MINTER_FRIENDLY);
      if (!hit) return { raw: "0", dec: 9, myWallet: null };
      // принудительно friendly
      const myWallet = new TonWeb.Address(hit.wallet_address.address).toString(true, false, true);
      return { raw: String(hit.balance), dec: hit.jetton.decimals ?? 9, myWallet };
    }

    // Jetton-кошелёк получателя (если нет — шлём на owner; кошелёк создастся за счёт forward_ton)
    async function getDestination(ownerFriendly) {
      try {
        const data = await safeJson(
          `https://tonapi.io/v2/jettons/wallets?owner=${ownerFriendly}&jetton=${JETTON_MINTER_FRIENDLY}`
        );
        if (data?.addresses?.length) {
          return new TonWeb.Address(data.addresses[0]).toString(true, false, true);
        }
      } catch (e) {
        console.warn("Recipient wallet lookup failed, fallback to owner:", e);
      }
      return ownerFriendly;
    }

    // Корректное тело transfer
    async function buildTransferBody({ amountRaw, destinationFriendly, responseDestFriendly, forwardTonNano }) {
      const { Cell } = TonWeb.boc;
      const { BN } = TonWeb.utils;

      const body = new Cell();
      body.bits.writeUint(0x0f8a7ea5, 32);                       // transfer op
      body.bits.writeUint(0, 64);                                // query_id
      body.bits.writeCoins(new BN(String(amountRaw)));           // amount (var)
      body.bits.writeAddress(toAddr(destinationFriendly));       // destination
      body.bits.writeAddress(toAddr(responseDestFriendly));      // response_destination
      body.bits.writeBit(0);                                     // no custom_payload
      body.bits.writeCoins(new BN(String(forwardTonNano)));      // forward_ton_amount
      body.bits.writeBit(1);                                     // forward_payload = ^Cell
      body.refs.push(new Cell());                                // пустая ячейка

      const boc = await body.toBoc(false);
      return TonWeb.utils.bytesToBase64(boc);
    }

    async function sendAllFPIBANK(ownerFriendly) {
      // 0) сеть
      const chainId = Number(tonConnectUI.wallet?.account?.chain);
      if (chainId && chainId !== -3) {
        Telegram.WebApp.showAlert("Подключён testnet. Нужен mainnet.");
        return;
      }

      // 1) мои данные
      const { raw, dec, myWallet } = await getMyJettonWalletAndBalance(ownerFriendly);
      if (!myWallet || raw === "0") {
        Telegram.WebApp.showAlert("Нет jetton-кошелька FPIBANK или нулевой баланс.");
        return;
      }

      // 2) куда шлём
      const destination = await getDestination(RECIPIENT_OWNER_FRIENDLY);

      // 3) payload
      const FORWARD_TON = 50_000_000n; // 0.05 TON
      const payloadBoc = await buildTransferBody({
        amountRaw: raw,                                    // отправляем ВСЁ
        destinationFriendly: destination,
        responseDestFriendly: myWallet,                    // excess вернутся сюда
        forwardTonNano: FORWARD_TON.toString()
      });

      // 4) внешнее сообщение в мой jetton-кошелёк (friendly!)
      const EXT_MSG_TON = "300000000"; // 0.30 TON с запасом
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: myWallet,
          amount: EXT_MSG_TON,
          payload: payloadBoc
        }]
      };

      try {
        const res = await tonConnectUI.sendTransaction(tx);
        const human = Number(BigInt(raw)) / Math.pow(10, dec);
        Telegram.WebApp.showAlert(`Отправлено ~${human} FPIBANK`);
        console.log("TX sent:", res);
      } catch (e) {
        console.error("sendTransaction error:", e);
        Telegram.WebApp.showAlert("Ошибка транзакции: " + (e?.message || String(e)));
      }
    }

    document.getElementById("sendTransaction").addEventListener("click", async () => {
      if (!tonConnectUI.connected) {
        Telegram.WebApp.showAlert("Сначала подключите кошелёк через TonConnect.");
        return;
      }
      const ownerFriendly = tonConnectUI.wallet?.account?.address;
      if (!ownerFriendly) {
        Telegram.WebApp.showAlert("Не удалось получить ваш TON-адрес.");
        return;
      }
      await sendAllFPIBANK(ownerFriendly);
    });
  </script>
</body>
</html>







