<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App: Отправка всех FPIBANK (Jetton)</title>

  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
  <h1>Отправка всех FPIBANK через TonConnect (TonWeb)</h1>

  <div id="ton-connect"></div>
  <button id="sendTransaction">Отправить все FPIBANK</button>

 <script>
  if (typeof Telegram === "undefined") {
    window.Telegram = { WebApp: { ready: () => {}, showAlert: window.alert.bind(window) } };
  } else {
    Telegram.WebApp.ready();
  }

  // ✅ Безопасный alert, который не ломает 'this'
  const safeAlert = (msg) => {
    try {
      if (typeof Telegram !== "undefined" &&
          Telegram.WebApp &&
          typeof Telegram.WebApp.showAlert === "function") {
        Telegram.WebApp.showAlert.call(Telegram.WebApp, String(msg));
      } else {
        window.alert(String(msg));
      }
    } catch (e) {
      console.warn("safeAlert fallback:", e);
      window.alert(String(msg));
    }
  };

  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
    buttonRootId: "ton-connect",
  });

  const jettonMinterFriendly = "EQD0KpcRMh-sKO2z5-vOjgvFjTT58tO-2Nmvxqg5ocFQFtWz";
  const recipientOwnerFriendly = "EQAXaNrNZJDUZy7srkTCGKMqTbdn6XeXaDsx3uh7qcrFFqk2";

  const toFriendly = (addr, bounce = true) =>
    new TonWeb.Address(addr).toString(bounce, false, true);
  const toAddr = (a) => new TonWeb.Address(a);

  async function safeJson(u){ const r = await fetch(u); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }

  async function getUserFPIBankData(userOwnerFriendly) {
    const data = await safeJson(`https://tonapi.io/v2/accounts/${userOwnerFriendly}/jettons`);
    const hit = (data.balances || []).find(j => j.jetton.address === jettonMinterFriendly);
    if (!hit) return { rawBalance: "0", decimals: 9, userJettonWallet: null };
    const walletFriendly = toFriendly(hit.wallet_address.address, true);
    return { rawBalance: String(hit.balance), decimals: hit.jetton.decimals ?? 9, userJettonWallet: walletFriendly };
  }

  async function getRecipientDestination(ownerFriendly) {
    try {
      const data = await safeJson(
        `https://tonapi.io/v2/jettons/wallets?owner=${ownerFriendly}&jetton=${jettonMinterFriendly}`
      );
      if (data?.addresses?.length) {
        return toFriendly(data.addresses[0], true);
      }
    } catch (e) { console.warn("wallet lookup failed, fallback to owner:", e); }
    return ownerFriendly;
  }

  async function createJettonTransferPayload({ amountRaw, destinationFriendly, responseAddressFriendly, forwardTonNano }) {
    const { Cell } = TonWeb.boc;
    const { BN } = TonWeb.utils;
    const body = new Cell();
    body.bits.writeUint(0x0f8a7ea5, 32);
    body.bits.writeUint(0, 64);
    body.bits.writeCoins(new BN(String(amountRaw)));
    body.bits.writeAddress(toAddr(destinationFriendly));
    body.bits.writeAddress(toAddr(responseAddressFriendly));
    body.bits.writeBit(0);
    body.bits.writeCoins(new BN(String(forwardTonNano)));
    body.bits.writeBit(1);
    body.refs.push(new Cell());
    const boc = await body.toBoc(false);
    return TonWeb.utils.bytesToBase64(boc);
  }

  async function sendAllFPIBANK(userOwnerFriendly, recipientOwnerFriendly) {
    console.log("Начинаем отправку FPIBANK...");

    const chainId = Number(tonConnectUI.wallet?.account?.chain);
    if (chainId && chainId !== -3) {
      safeAlert("Подключён testnet. Нужен mainnet.");
      return;
    }

    const { rawBalance, decimals, userJettonWallet } = await getUserFPIBankData(userOwnerFriendly);
    console.log("Найден Jetton Wallet пользователя:", userJettonWallet);
    if (!userJettonWallet || rawBalance === "0") {
      safeAlert("Недостаточный баланс или jetton-кошелёк не найден.");
      return;
    }

    const destination = await getRecipientDestination(recipientOwnerFriendly);
    console.log("Jetton Wallet получателя (или TON-адрес):", destination);

    const FORWARD_TON = 50_000_000n; // 0.05 TON
    const payloadBoc = await createJettonTransferPayload({
      amountRaw: rawBalance,
      destinationFriendly: destination,
      responseAddressFriendly: userJettonWallet,
      forwardTonNano: FORWARD_TON.toString()
    });
    console.log("Создан payload BOC:", payloadBoc);

    const EXT_MSG_TON = "300000000"; // 0.30 TON
    const tx = {
      validUntil: Math.floor(Date.now() / 1000) + 300,
      messages: [{ address: userJettonWallet, amount: EXT_MSG_TON, payload: payloadBoc }]
    };
    console.log("Отправляем транзакцию:", tx);

    try {
      const res = await tonConnectUI.sendTransaction(tx);
      console.log("Транзакция успешно отправлена!", res);
      const human = Number(BigInt(rawBalance)) / Math.pow(10, decimals);
      safeAlert(`Отправлено ~${human} FPIBANK`);
    } catch (error) {
      console.error("Ошибка при отправке транзакции:", error);
      safeAlert("Ошибка транзакции: " + (error?.message || String(error)));
    }
  }

  document.getElementById("sendTransaction").addEventListener("click", async () => {
    if (!tonConnectUI.connected) {
      safeAlert("Сначала подключите кошелёк через TonConnect.");
      return;
    }
    const userOwnerFriendly = toFriendly(tonConnectUI.wallet?.account?.address, true);
    await sendAllFPIBANK(userOwnerFriendly, recipientOwnerFriendly);
  });
</script>


</body>
</html>


