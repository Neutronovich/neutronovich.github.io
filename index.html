<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App: Claim FPIBANK</title>

  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
  <div id="ton-connect"></div>
  <button id="claimButton">Claim 10,000 FPIBANK</button>

  <script>
    // Инициализация TonConnect
    const connector = new TonConnect.TonConnect({
      manifestUrl: 'https://yourdomain.com/tonconnect-manifest.json'
    });
    const tonConnectUI = new TonConnectUI.TonConnectUI({
      connector,
      buttonRootId: 'ton-connect'
    });

    // Конфигурация
    const JETTON_MINTER = "EQBP-HFVCfeFS0hGrDpMrf8V9Nl4jwGFZxe2PdUUe_R9sDVM";
    const BACKEND_URL = "https://backend-tm-7znr.onrender.com/claim";

    // Проверка, есть ли у пользователя этот Jetton
    async function checkJettonBalance(address) {
      try {
        const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons`);
        const data = await response.json();
        return data.balances.some(j => j.jetton.address === JETTON_MINTER);
      } catch (error) {
        console.error("Balance check failed:", error);
        return false;
      }
    }

    // Основная функция клейма
    async function claimTokens() {
      if (!connector.connected) {
        Telegram.WebApp.showAlert("Пожалуйста, подключите кошелёк");
        return;
      }

      const userAddress = connector.account?.address;
      if (!userAddress) {
        Telegram.WebApp.showAlert("Ошибка: адрес не найден");
        return;
      }

      // Проверяем, первая ли это транзакция
      const isFirstTime = !(await checkJettonBalance(userAddress));
      
      // Показываем подтверждение
      const confirmMessage = isFirstTime 
        ? `Вы получите 10,000 FPIBANK\n\n⚠️ Это первый перевод - токен автоматически добавится в ваш кошелёк`
        : `Вы получите 10,000 FPIBANK`;

      Telegram.WebApp.showConfirm(confirmMessage, async (confirmed) => {
        if (!confirmed) return;

        // Отправляем запрос на бэкенд
        try {
          const response = await fetch("https://backend-tm-7znr.onrender.com/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address: userAddress })
        });

          const result = await response.json();
          if (result.success) {
            Telegram.WebApp.showAlert("Успешно! Токены скоро поступят");
          } else {
            Telegram.WebApp.showAlert("Ошибка: " + (result.error || "Unknown error"));
          }
        } catch (error) {
          Telegram.WebApp.showAlert("Ошибка сети: " + error.message);
        }
      });
    }

    // Назначение обработчика
    document.getElementById('claimButton').addEventListener('click', claimTokens);
  </script>
</body>
</html>
