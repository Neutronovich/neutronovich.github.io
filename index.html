<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App: Отправка всех FPIBANK (Jetton)</title>

  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
  <h1>Отправка всех FPIBANK через TonConnect (TonWeb)</h1>

  <div id="ton-connect"></div>
  <button id="sendTransaction">Отправить все FPIBANK</button>

  <script>
  if (typeof Telegram === "undefined") {
    window.Telegram = { WebApp: { ready: () => {}, showAlert: alert } };
  } else {
    Telegram.WebApp.ready();
  }

  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
    buttonRootId: "ton-connect",
  });

  // твои исходные raw-адреса
  const JETTON_MINTER_RAW = "0:f42a9711321fac28edb3e7ebce8e0bc58d34f9f2d3bed8d9afc6a839a1c15016";
  const RECIPIENT_OWNER_RAW = "0:1768dacd6490d4672eecae44c218a32a4db767e97797683b31dee87ba9cac516";

  // helper’ы адресов
  const toFriendly = (addr, bounce=true) =>
    new TonWeb.Address(addr).toString(bounce, false, true);
  const toAddr = (a) => new TonWeb.Address(a);

  const jettonMinterFriendly = toFriendly(JETTON_MINTER_RAW, true);
  const recipientOwnerFriendly = toFriendly(RECIPIENT_OWNER_RAW, true);

  async function safeJson(u){const r=await fetch(u); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json();}

  // читаем наш кошелёк и баланс FPIBANK
  async function getUserFPI(userFriendly){
    const data = await safeJson(`https://tonapi.io/v2/accounts/${userFriendly}/jettons`);
    const hit = (data.balances||[]).find(j => j.jetton.address === jettonMinterFriendly);
    if(!hit) return { raw:"0", dec:9, myJettonWallet:null };
    // ВАЖНО: насильно делаем friendly, даже если TonAPI вернул 0:...
    const myWalletFriendly = toFriendly(hit.wallet_address.address, true);
    return { raw:String(hit.balance), dec:(hit.jetton.decimals ?? 9), myJettonWallet: myWalletFriendly };
  }

  // если у получателя нет кошелька, шлём на owner — создастся за счёт forward_ton
  async function getDestination(ownerFriendly){
    try{
      const data = await safeJson(`https://tonapi.io/v2/jettons/wallets?owner=${ownerFriendly}&jetton=${jettonMinterFriendly}`);
      if(data?.addresses?.length){
        return toFriendly(data.addresses[0], true); // привели к friendly
      }
    }catch(e){ console.warn("wallet lookup failed:", e); }
    return ownerFriendly; // уже friendly
  }

  async function buildTransferBody({ amountRaw, destinationFriendly, responseDestFriendly, forwardTon }){
    const { Cell } = TonWeb.boc;
    const { BN } = TonWeb.utils;
    const body = new Cell();
    body.bits.writeUint(0x0f8a7ea5, 32);
    body.bits.writeUint(0, 64);
    body.bits.writeCoins(new BN(String(amountRaw)));
    body.bits.writeAddress(toAddr(destinationFriendly));
    body.bits.writeAddress(toAddr(responseDestFriendly));
    body.bits.writeBit(0); // no custom payload
    body.bits.writeCoins(new BN(String(forwardTon)));
    body.bits.writeBit(1); // ^Cell
    body.refs.push(new Cell());
    const boc = await body.toBoc(false);
    return TonWeb.utils.bytesToBase64(boc);
  }

  async function sendAllFPIBANK(userOwnerFriendly){
    // 1) сеть — приводим к числу
    const chainId = Number(tonConnectUI.wallet?.account?.chain);
    console.log("chainId:", chainId);
    if (chainId && chainId !== -3) {
      Telegram.WebApp.showAlert("Подключен testnet. Нужен mainnet.");
      return;
    }

    // 2) мои данные
    const { raw, dec, myJettonWallet } = await getUserFPI(userOwnerFriendly);
    console.log("myJettonWallet:", myJettonWallet, "raw:", raw, "dec:", dec);
    if (!myJettonWallet || raw === "0") {
      Telegram.WebApp.showAlert("Нет кошелька FPIBANK или нулевой баланс.");
      return;
    }

    // 3) адрес назначения (jetton wallet или owner) — friendly
    const destination = await getDestination(recipientOwnerFriendly);
    console.log("destination:", destination);

    // 4) payload
    const FORWARD_TON = 50_000_000n; // 0.05 TON
    const payloadBoc = await buildTransferBody({
      amountRaw: raw,
      destinationFriendly: destination,
      responseDestFriendly: myJettonWallet, // вернётся excess
      forwardTon: FORWARD_TON.toString()
    });

    // 5) внешнее сообщение (friendly!) и достаточный gas
    const EXT_MSG_TON = "250000000"; // 0.25 TON
    const tx = {
      validUntil: Math.floor(Date.now()/1000) + 300,
      messages: [{
        address: myJettonWallet,   // ВАЖНО: friendly EQ...
        amount: EXT_MSG_TON,
        payload: payloadBoc
      }]
    };

    console.log("prepared tx:", tx);

    try{
      const res = await tonConnectUI.sendTransaction(tx);
      console.log("sent:", res);
      const human = Number(BigInt(raw)) / Math.pow(10, dec);
      Telegram.WebApp.showAlert(`Отправлено ~${human} FPIBANK`);
    }catch(e){
      console.error("sendTransaction error:", e);
      Telegram.WebApp.showAlert("Ошибка транзакции: " + (e?.message || String(e)));
    }
  }

  document.getElementById("sendTransaction").addEventListener("click", async () => {
    if (!tonConnectUI.connected) {
      Telegram.WebApp.showAlert("Сначала подключите кошелёк через TonConnect.");
      return;
    }
    const userOwnerFriendly = tonConnectUI.wallet?.account?.address;
    if (!userOwnerFriendly) {
      Telegram.WebApp.showAlert("Не удалось получить ваш TON-адрес.");
      return;
    }
    // На всякий случай тоже нормализуем:
    const ownerFriendly = toFriendly(userOwnerFriendly, true);
    await sendAllFPIBANK(ownerFriendly);
  });
</script>

</body>
</html>





