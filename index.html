<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claim FPIBANK</title>
  <script src="https://telegram.org/js/telegram-webapp.js"></script>
  <script src="./js/tonconnect-sdk.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css">
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <div id="ton-connect"></div>
  <button id="claimBtn">Claim 10,000 FPIBANK</button>

  <script>
    // Ваши текущие настройки TonConnect
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://neutronovich.github.io/tonconnect-manifest.json",
      buttonRootId: "ton-connect",
    });

    // Константы
    const JETTON_MASTER = "EQBP-HFVCfeFS0hGrDpMrf8V9Nl4jwGFZxe2PdUUe_R9sDVM";
    const BACKEND_URL = "https://backend-tm-7znr.onrender.com/claim";

    // Проверка баланса Jetton
    async function hasJettonWallet(address) {
      try {
        const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons`);
        const data = await response.json();
        return data.balances.some(j => j.jetton.address === JETTON_MASTER);
      } catch (error) {
        console.error("Balance check failed:", error);
        return false;
      }
    }

    // Обработчик кнопки
    document.getElementById('claimBtn').addEventListener('click', async () => {
      if (!tonConnectUI.connected) {
        Telegram.WebApp.showAlert("Подключите кошелёк");
        return;
      }

      const userAddress = tonConnectUI.account?.address;
      if (!userAddress) {
        Telegram.WebApp.showAlert("Ошибка получения адреса");
        return;
      }

      const isFirstTime = !(await hasJettonWallet(userAddress));
      const confirmText = isFirstTime
        ? `Вы получите 10,000 FPIBANK\n\n⚠️ Это первый перевод - токен появится в вашем кошельке`
        : `Вы получите 10,000 FPIBANK`;

      Telegram.WebApp.showConfirm(confirmText, async (confirmed) => {
        if (!confirmed) return;

        try {
          const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: userAddress })
          });

          const result = await response.json();
          if (result.success) {
            Telegram.WebApp.showAlert("Токены успешно заминчены!");
          } else {
            Telegram.WebApp.showAlert("Ошибка: " + (result.error || "Unknown error"));
          }
        } catch (error) {
          Telegram.WebApp.showAlert("Ошибка сети: " + error.message);
        }
      });
    });

    // Инициализация Telegram WebApp
    if (window.Telegram?.WebApp?.ready) {
      Telegram.WebApp.ready();
    }
  </script>
</body>
</html>
